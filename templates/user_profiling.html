{% extends "base.html" %}
{% block title %}User Profiling ‚Äî PromptDefender Pro{% endblock %}
{% block breadcrumb %}USER_PROFILING{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <div class="page-title-icon" style="background:rgba(124,58,237,0.1);border:1px solid rgba(124,58,237,0.3);">üë§</div>
        User Behavior Analysis
    </div>
    <div class="page-subtitle">// Session-based risk profiling and behavioral analytics</div>
</div>

<!-- User stats -->
<div class="stat-grid">
    <div class="stat-card cyan">
        <div class="stat-icon">üîç</div>
        <div class="stat-label">Total Requests</div>
        <div class="stat-value" id="p-total">0</div>
        <div class="stat-meta">This session</div>
    </div>
    <div class="stat-card danger">
        <div class="stat-icon">üö´</div>
        <div class="stat-label">Blocked</div>
        <div class="stat-value" id="p-blocked">0</div>
        <div class="stat-meta">Threats intercepted</div>
    </div>
    <div class="stat-card amber">
        <div class="stat-icon">‚ö†Ô∏è</div>
        <div class="stat-label">Threat Rate</div>
        <div class="stat-value" id="p-rate">0%</div>
        <div class="stat-meta">Block ratio</div>
    </div>
    <div class="stat-card green">
        <div class="stat-icon">ü§ñ</div>
        <div class="stat-label">Avg ML Conf.</div>
        <div class="stat-value" id="p-conf">0%</div>
        <div class="stat-meta">Model certainty</div>
    </div>
</div>

<div class="row">
    <!-- Risk Profile -->
    <div class="col-6">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Session Risk Profile</div>
                <button class="btn btn-primary" id="refresh-profile" onclick="loadProfile()">‚Üª Refresh</button>
            </div>
            <div class="card-body">
                <div class="profile-header-ui">
                    <div class="profile-avatar-big">üë§</div>
                    <div>
                        <div class="profile-name-big">Default Session</div>
                        <div id="risk-badge" class="risk-badge risk-low">LOW RISK PROFILE</div>
                    </div>
                </div>

                <div class="risk-meter-wrap">
                    <div class="risk-label-row">
                        <span class="detail-key">Risk Score</span>
                        <span id="risk-score-val" class="risk-score-val">0%</span>
                    </div>
                    <div class="risk-meter-track">
                        <div class="risk-meter-fill" id="risk-meter-fill"></div>
                        <div class="risk-meter-marks">
                            <span>0</span><span>25</span><span>50</span><span>75</span><span>100</span>
                        </div>
                    </div>
                </div>

                <div class="behavior-chips" id="behavior-chips">
                    <div class="b-chip chip-safe">‚úÖ Normal activity pattern</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Risk doughnut -->
    <div class="col-6">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Risk Distribution</div>
            </div>
            <div class="card-body" style="display:flex;align-items:center;justify-content:center;">
                <div class="donut-wrap">
                    <svg id="donut-svg" viewBox="0 0 200 200" width="200" height="200">
                        <circle cx="100" cy="100" r="70" fill="none" stroke="#111" stroke-width="28"/>
                        <circle id="donut-safe" cx="100" cy="100" r="70" fill="none"
                            stroke="var(--green)" stroke-width="28"
                            stroke-dasharray="0 440" stroke-linecap="round"
                            transform="rotate(-90 100 100)" style="transition:stroke-dasharray 0.8s ease"/>
                        <circle id="donut-medium" cx="100" cy="100" r="70" fill="none"
                            stroke="var(--amber)" stroke-width="28"
                            stroke-dasharray="0 440" stroke-linecap="round"
                            transform="rotate(-90 100 100)" style="transition:stroke-dasharray 0.8s ease"/>
                        <circle id="donut-high" cx="100" cy="100" r="70" fill="none"
                            stroke="var(--red)" stroke-width="28"
                            stroke-dasharray="0 440" stroke-linecap="round"
                            transform="rotate(-90 100 100)" style="transition:stroke-dasharray 0.8s ease"/>
                    </svg>
                    <div class="donut-legend">
                        <div class="dleg"><div class="dleg-dot" style="background:var(--green)"></div>Safe</div>
                        <div class="dleg"><div class="dleg-dot" style="background:var(--amber)"></div>Medium Risk</div>
                        <div class="dleg"><div class="dleg-dot" style="background:var(--red)"></div>High Risk</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Activity timeline -->
<div class="card">
    <div class="card-header">
        <div class="card-title">Activity Timeline</div>
    </div>
    <div class="card-body" style="padding:0 20px;">
        <div id="timeline" class="timeline">
            <div class="tl-empty">No activity recorded yet</div>
        </div>
    </div>
</div>

<style>
.profile-header-ui {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: var(--bg-deep);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 20px;
}

.profile-avatar-big {
    width: 60px;
    height: 60px;
    border-radius: 10px;
    background: linear-gradient(135deg, var(--purple), var(--cyan));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    flex-shrink: 0;
}

.profile-name-big {
    font-family: var(--font-display);
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 6px;
}

.risk-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 4px;
    font-family: var(--text-mono);
    font-size: 0.62rem;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    font-weight: 700;
}

.risk-low { background: var(--green-glow); color: var(--green); border: 1px solid rgba(0,255,136,0.3); }
.risk-medium { background: var(--amber-glow); color: var(--amber); border: 1px solid rgba(255,184,0,0.3); }
.risk-high { background: var(--red-glow); color: var(--red); border: 1px solid rgba(255,45,85,0.3); }

.risk-meter-wrap { margin-bottom: 20px; }

.risk-label-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.detail-key {
    font-family: var(--text-mono);
    font-size: 0.65rem;
    color: var(--text-secondary);
    letter-spacing: 1px;
    text-transform: uppercase;
}

.risk-score-val {
    font-family: var(--font-display);
    font-size: 1.1rem;
    font-weight: 800;
    color: var(--green);
}

.risk-meter-track {
    height: 8px;
    background: var(--bg-deep);
    border-radius: 4px;
    overflow: hidden;
    border: 1px solid var(--border);
    margin-bottom: 4px;
    position: relative;
}

.risk-meter-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, var(--green), var(--amber) 50%, var(--red));
    border-radius: 4px;
    transition: width 0.8s ease;
}

.risk-meter-marks {
    display: flex;
    justify-content: space-between;
    font-family: var(--text-mono);
    font-size: 0.55rem;
    color: var(--text-secondary);
    margin-top: 4px;
}

.behavior-chips { display: flex; flex-wrap: wrap; gap: 8px; }

.b-chip {
    padding: 6px 12px;
    border-radius: 4px;
    font-family: var(--text-mono);
    font-size: 0.65rem;
    letter-spacing: 0.5px;
}

.chip-safe { background: var(--green-glow); color: var(--green); border: 1px solid rgba(0,255,136,0.2); }
.chip-warn { background: var(--amber-glow); color: var(--amber); border: 1px solid rgba(255,184,0,0.2); }
.chip-threat { background: var(--red-glow); color: var(--red); border: 1px solid rgba(255,45,85,0.2); }

/* Donut */
.donut-wrap { display: flex; flex-direction: column; align-items: center; gap: 20px; }

.donut-legend { display: flex; gap: 20px; }

.dleg { display: flex; align-items: center; gap: 6px; font-family: var(--text-mono); font-size: 0.65rem; color: var(--text-secondary); }

.dleg-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

/* Timeline */
.timeline { padding: 20px 0; position: relative; }

.timeline::before {
    content: '';
    position: absolute;
    left: 8px; top: 0; bottom: 0;
    width: 1px;
    background: var(--border);
}

.tl-item {
    display: flex;
    gap: 16px;
    margin-bottom: 20px;
    padding-left: 30px;
    position: relative;
}

.tl-item::before {
    content: '';
    position: absolute;
    left: 4px;
    top: 8px;
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.tl-item.blocked::before { background: var(--red); box-shadow: 0 0 6px var(--red); }
.tl-item.safe::before { background: var(--green); box-shadow: 0 0 6px var(--green); }

.tl-time {
    font-family: var(--text-mono);
    font-size: 0.6rem;
    color: var(--text-secondary);
    padding-top: 2px;
    white-space: nowrap;
    flex-shrink: 0;
    width: 130px;
}

.tl-content {
    background: var(--bg-deep);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 12px;
    flex: 1;
}

.tl-title {
    font-family: var(--text-mono);
    font-size: 0.72rem;
    color: var(--text-primary);
    margin-bottom: 3px;
}

.tl-desc {
    font-family: var(--text-mono);
    font-size: 0.62rem;
    color: var(--text-secondary);
}

.tl-empty {
    padding: 28px;
    font-family: var(--text-mono);
    font-size: 0.72rem;
    color: var(--text-secondary);
    text-align: center;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', loadProfile);

async function loadProfile() {
    try {
        const [stats, logs] = await Promise.all([apiCall('/api/stats'), apiCall('/api/logs')]);
        const total = logs.logs.length;
        const blocked = logs.logs.filter(l => l.blocked).length;
        const allowed = total - blocked;
        const rate = total > 0 ? Math.round((blocked/total)*100) : 0;
        const avgConf = total > 0
            ? Math.round(logs.logs.reduce((s, l) => s + l.ml_confidence, 0) / total * 100)
            : 0;

        document.getElementById('p-total').textContent = total;
        document.getElementById('p-blocked').textContent = blocked;
        document.getElementById('p-rate').textContent = rate + '%';
        document.getElementById('p-conf').textContent = avgConf + '%';

        // Risk meter
        document.getElementById('risk-meter-fill').style.width = rate + '%';
        document.getElementById('risk-score-val').textContent = rate + '%';

        const badge = document.getElementById('risk-badge');
        if (rate > 30) {
            badge.className = 'risk-badge risk-high'; badge.textContent = 'HIGH RISK PROFILE';
        } else if (rate > 10) {
            badge.className = 'risk-badge risk-medium'; badge.textContent = 'MEDIUM RISK PROFILE';
        } else {
            badge.className = 'risk-badge risk-low'; badge.textContent = 'LOW RISK PROFILE';
        }

        // Behavior chips
        const chips = [];
        if (rate === 0) chips.push('<div class="b-chip chip-safe">‚úÖ No threats detected this session</div>');
        if (rate > 0 && rate <= 15) chips.push('<div class="b-chip chip-safe">‚úÖ Normal activity pattern</div>');
        if (rate > 15 && rate <= 30) chips.push('<div class="b-chip chip-warn">‚ö†Ô∏è Elevated threat attempts</div>');
        if (rate > 30) chips.push('<div class="b-chip chip-threat">üö´ High frequency attack pattern</div>');
        if (avgConf > 70) chips.push('<div class="b-chip chip-threat">ü§ñ High ML confidence detections</div>');
        if (total > 10) chips.push('<div class="b-chip chip-warn">üìä High request volume</div>');
        document.getElementById('behavior-chips').innerHTML = chips.join('') || '<div class="b-chip chip-safe">‚úÖ Normal activity pattern</div>';

        // Donut (simple SVG path approach)
        updateDonut(allowed, blocked * 0.5, blocked * 0.5, total);

        // Timeline
        const tl = document.getElementById('timeline');
        const recent = [...logs.logs].reverse().slice(0, 8);
        if (recent.length === 0) {
            tl.innerHTML = '<div class="tl-empty">No activity recorded yet</div>';
        } else {
            tl.innerHTML = recent.map(l => `
                <div class="tl-item ${l.blocked ? 'blocked' : 'safe'}">
                    <div class="tl-time">${l.timestamp}</div>
                    <div class="tl-content">
                        <div class="tl-title">${l.blocked ? 'üö´ Blocked' : '‚úÖ Allowed'}: ${l.prompt.substring(0,50)}${l.prompt.length>50?'‚Ä¶':''}</div>
                        <div class="tl-desc">${l.reason || 'No specific reason'} ${l.layer ? '‚Ä¢ '+l.layer : ''}</div>
                    </div>
                </div>
            `).join('');
        }

        showNotification('Profile refreshed', 'success');
    } catch(e) {}
}

function updateDonut(safe, medium, high, total) {
    const C = 2 * Math.PI * 70; // circumference ‚âà 440
    if (total === 0) { return; }
    const safePct = safe / total;
    const medPct = medium / total;
    const highPct = high / total;

    const safeLen = safePct * C;
    const medLen = medPct * C;
    const highLen = highPct * C;

    document.getElementById('donut-safe').setAttribute('stroke-dasharray', `${safeLen} ${C - safeLen}`);
    const medOffset = C - safeLen;
    document.getElementById('donut-medium').setAttribute('stroke-dasharray', `${medLen} ${C - medLen}`);
    document.getElementById('donut-medium').setAttribute('stroke-dashoffset', -safeLen);
    document.getElementById('donut-high').setAttribute('stroke-dasharray', `${highLen} ${C - highLen}`);
    document.getElementById('donut-high').setAttribute('stroke-dashoffset', -(safeLen + medLen));
}
</script>
{% endblock %}
